import{_ as It}from"./B2tdp_o7.js";import{g as Dt,i as Z,C as ut,q as St,s as dt,v as $t,r as Nt,o as G,c as K,a as D,X as ht,x as L,F as xt,k as Mt,b as bt,t as jt,j as qt,Q as Et,p as Lt,e as Ft,Y as Ot,Z as Vt}from"./BYXYRwLn.js";import{s as j,t as ft,c as pt}from"./nBtS1XGq.js";import{a as P}from"./D7zcYHcO.js";import{l as Ht}from"./ntdiYfc-.js";import{f as zt}from"./D2nGpDRe.js";import{_ as Pt}from"./DlAUqK2U.js";function Wt(t){var n=0,o=t.children,a=o&&o.length;if(!a)n=1;else for(;--a>=0;)n+=o[a].value;t.value=n}function Xt(){return this.eachAfter(Wt)}function Yt(t,n){let o=-1;for(const a of this)t.call(n,a,++o,this);return this}function Zt(t,n){for(var o=this,a=[o],c,h,u=-1;o=a.pop();)if(t.call(n,o,++u,this),c=o.children)for(h=c.length-1;h>=0;--h)a.push(c[h]);return this}function Gt(t,n){for(var o=this,a=[o],c=[],h,u,v,z=-1;o=a.pop();)if(c.push(o),h=o.children)for(u=0,v=h.length;u<v;++u)a.push(h[u]);for(;o=c.pop();)t.call(n,o,++z,this);return this}function Qt(t,n){let o=-1;for(const a of this)if(t.call(n,a,++o,this))return a}function Jt(t){return this.eachAfter(function(n){for(var o=+t(n.data)||0,a=n.children,c=a&&a.length;--c>=0;)o+=a[c].value;n.value=o})}function Kt(t){return this.eachBefore(function(n){n.children&&n.children.sort(t)})}function Ut(t){for(var n=this,o=te(n,t),a=[n];n!==o;)n=n.parent,a.push(n);for(var c=a.length;t!==o;)a.splice(c,0,t),t=t.parent;return a}function te(t,n){if(t===n)return t;var o=t.ancestors(),a=n.ancestors(),c=null;for(t=o.pop(),n=a.pop();t===n;)c=t,t=o.pop(),n=a.pop();return c}function ee(){for(var t=this,n=[t];t=t.parent;)n.push(t);return n}function ne(){return Array.from(this)}function oe(){var t=[];return this.eachBefore(function(n){n.children||t.push(n)}),t}function ae(){var t=this,n=[];return t.each(function(o){o!==t&&n.push({source:o.parent,target:o})}),n}function*ie(){var t=this,n,o=[t],a,c,h;do for(n=o.reverse(),o=[];t=n.pop();)if(yield t,a=t.children)for(c=0,h=a.length;c<h;++c)o.push(a[c]);while(o.length)}function mt(t,n){t instanceof Map?(t=[void 0,t],n===void 0&&(n=ce)):n===void 0&&(n=se);for(var o=new ot(t),a,c=[o],h,u,v,z;a=c.pop();)if((u=n(a.data))&&(z=(u=Array.from(u)).length))for(a.children=u,v=z-1;v>=0;--v)c.push(h=u[v]=new ot(u[v])),h.parent=a,h.depth=a.depth+1;return o.eachBefore(ue)}function re(){return mt(this).eachBefore(le)}function se(t){return t.children}function ce(t){return Array.isArray(t)?t[1]:null}function le(t){t.data.value!==void 0&&(t.value=t.data.value),t.data=t.data.data}function ue(t){var n=0;do t.height=n;while((t=t.parent)&&t.height<++n)}function ot(t){this.data=t,this.depth=this.height=0,this.parent=null}ot.prototype=mt.prototype={constructor:ot,count:Xt,each:Yt,eachAfter:Gt,eachBefore:Zt,find:Qt,sum:Jt,sort:Kt,path:Ut,ancestors:ee,descendants:ne,leaves:oe,links:ae,copy:re,[Symbol.iterator]:ie};function de(t){if(typeof t!="function")throw new Error;return t}function tt(){return 0}function et(t){return function(){return t}}function he(t){t.x0=Math.round(t.x0),t.y0=Math.round(t.y0),t.x1=Math.round(t.x1),t.y1=Math.round(t.y1)}function fe(t,n,o,a,c){for(var h=t.children,u,v=-1,z=h.length,x=t.value&&(a-n)/t.value;++v<z;)u=h[v],u.y0=o,u.y1=c,u.x0=n,u.x1=n+=u.value*x}function pe(t,n,o,a,c){for(var h=t.children,u,v=-1,z=h.length,x=t.value&&(c-o)/t.value;++v<z;)u=h[v],u.x0=n,u.x1=a,u.y0=o,u.y1=o+=u.value*x}var me=(1+Math.sqrt(5))/2;function ge(t,n,o,a,c,h){for(var u=[],v=n.children,z,x,m=0,d=0,e=v.length,_,y,k=n.value,p,M,S,F,q,R,$;m<e;){_=c-o,y=h-a;do p=v[d++].value;while(!p&&d<e);for(M=S=p,R=Math.max(y/_,_/y)/(k*t),$=p*p*R,q=Math.max(S/$,$/M);d<e;++d){if(p+=x=v[d].value,x<M&&(M=x),x>S&&(S=x),$=p*p*R,F=Math.max(S/$,$/M),F>q){p-=x;break}q=F}u.push(z={value:p,dice:_<y,children:v.slice(m,d)}),z.dice?fe(z,o,a,c,k?a+=y*p/k:h):pe(z,o,a,k?o+=_*p/k:c,h),k-=p,m=d}return u}const ve=function t(n){function o(a,c,h,u,v){ge(n,a,c,h,u,v)}return o.ratio=function(a){return t((a=+a)>1?a:1)},o}(me);function _e(){var t=ve,n=!1,o=1,a=1,c=[0],h=tt,u=tt,v=tt,z=tt,x=tt;function m(e){return e.x0=e.y0=0,e.x1=o,e.y1=a,e.eachBefore(d),c=[0],n&&e.eachBefore(he),e}function d(e){var _=c[e.depth],y=e.x0+_,k=e.y0+_,p=e.x1-_,M=e.y1-_;p<y&&(y=p=(y+p)/2),M<k&&(k=M=(k+M)/2),e.x0=y,e.y0=k,e.x1=p,e.y1=M,e.children&&(_=c[e.depth+1]=h(e)/2,y+=x(e)-_,k+=u(e)-_,p-=v(e)-_,M-=z(e)-_,p<y&&(y=p=(y+p)/2),M<k&&(k=M=(k+M)/2),t(e,y,k,p,M))}return m.round=function(e){return arguments.length?(n=!!e,m):n},m.size=function(e){return arguments.length?(o=+e[0],a=+e[1],m):[o,a]},m.tile=function(e){return arguments.length?(t=de(e),m):t},m.padding=function(e){return arguments.length?m.paddingInner(e).paddingOuter(e):m.paddingInner()},m.paddingInner=function(e){return arguments.length?(h=typeof e=="function"?e:et(+e),m):h},m.paddingOuter=function(e){return arguments.length?m.paddingTop(e).paddingRight(e).paddingBottom(e).paddingLeft(e):m.paddingTop()},m.paddingTop=function(e){return arguments.length?(u=typeof e=="function"?e:et(+e),m):u},m.paddingRight=function(e){return arguments.length?(v=typeof e=="function"?e:et(+e),m):v},m.paddingBottom=function(e){return arguments.length?(z=typeof e=="function"?e:et(+e),m):z},m.paddingLeft=function(e){return arguments.length?(x=typeof e=="function"?e:et(+e),m):x},m}function we(t,n,o,a,c){var h=t.children,u,v=h.length,z,x=new Array(v+1);for(x[0]=z=u=0;u<v;++u)x[u+1]=z+=h[u].value;m(0,v,t.value,n,o,a,c);function m(d,e,_,y,k,p,M){if(d>=e-1){var S=h[d];S.x0=y,S.y0=k,S.x1=p,S.y1=M;return}for(var F=x[d],q=_/2+F,R=d+1,$=e-1;R<$;){var U=R+$>>>1;x[U]<q?R=U+1:$=U}q-x[R-1]<x[R]-q&&d+1<R&&--R;var W=x[R]-F,X=_-W;if(p-y>M-k){var Q=_?(y*X+p*W)/_:p;m(d,R,W,y,k,Q,M),m(R,e,X,Q,k,p,M)}else{var nt=_?(k*X+M*W)/_:M;m(d,R,W,y,k,p,nt),m(R,e,X,y,nt,p,M)}}}const at=t=>(Lt("data-v-897737a2"),t=t(),Ft(),t),ye={class:"sticky top section"},ke={class:"section",style:{"padding-top":"0"}},xe={class:"container"},Me={key:0,style:{height:"70vh"}},be=at(()=>D("td",null," . ",-1)),ze=at(()=>D("td",null," .. ",-1)),Be=at(()=>D("td",null," % ",-1)),Re=at(()=>D("tbody",null,null,-1)),Ae=["width","height"],Te={class:"section"},Ce={class:"container"},Ie=["width","height"],De={class:"sticky bottom section"},Se=Dt({__name:"Treemap",props:{repositories:{type:Array[String],default:()=>["chromium"]},path:{},field_color:{},field_size:{},colormap:{},colormapMin:{},colormapMax:{},dates:{},animate:{type:Boolean,default:!1}},emits:["zoomin","animationend"],setup(t,{emit:n}){const{$color_map:o}=Et(),a=Z(null),c=Z(null),h=Z(null);Z(null);const u=Z("Tooltip"),v=ut(void 0),z=ut({}),x=ut([]);let m=o[0];const d=t,e=n,_=Z(600),y=Z(600),k=function(i){let s=0;for(const f of d.field_color)s+=i.summed_data[f]||0;return s},p=function(i){let s=0;for(const f of d.field_size)s+=i.summed_data[f]||0;return s},M=function(i,s,f){return i.attr("transform",r=>`translate(${s(r.x0)}, ${f(r.y0)})`)},S=function(i,s,f,r){return i.attr("rx",10).attr("stroke","white").attr("stroke-width",5).attr("fill-opacity",.9).attr("width",l=>s(l.x1)-s(l.x0)).attr("height",l=>f(l.y1)-f(l.y0)).style("fill",l=>{const g=P().domain([d.colormapMin||0,d.colormapMax||1]).range([0,1]),b=k(l.data),T=p(l.data),w="gray",A=m(g(b/T));return Ot(w,A)(r?.5:.9)})},F=function(i,s){return i.attr("text-anchor","start").attr("alignment-baseline","middle").attr("x",8).attr("opacity",.5-s*.2).style("font-weight",s==0?"bold":"normal")},q=function(i,s,f){const r=P().domain([d.colormapMin||0,d.colormapMax||1]).range([0,1]),l=g=>{const b=p(f.data),w=p(g.data)/b*10;return w<.02?0:Math.min(20,Math.sqrt(w)*30)};return i.style("fill",g=>{const b=k(g.data),T=p(g.data),w=m(r(b/T));return Vt(w).l<.5?"white":"black"}).style("font-size",l).attr("y",g=>5+l(g)*(s+1)*1.2).text(g=>{const b=g.data.name,T=k(g.data),w=p(g.data),A=Math.floor(100*T/w);return s==0?`${b}`:`${T}/${w} = ${A}%`})},R=function(i,s,f,r,l=!1,g){const T=(w=>w.join(A=>{const B=A.append("g"),C=B.append("rect"),I=B.append("text"),N=B.append("text");return M(B,f,r),S(C,f,r,!1),F(I,0),F(N,1),q(I,0,s),q(N,1,s),B},A=>{const B=A.transition(g),C=B.select("rect"),I=B.selectAll("text");return M(B,f,r),S(C,f,r,!1),I.each((N,V,H)=>{const J=j(H[V]),rt=l?J:J.transition(g);q(rt,V,s)}),A},A=>A.remove()))(i.selectAll("g").data(s.children,w=>w.data.name));T.filter(w=>w.children).attr("cursor","pointer").on("click",(w,A)=>$(A)),T.on("mousemove",(w,A)=>{const B=j(w.currentTarget).select("rect");S(B,f,r,!0),u.value=A.data.name,j(h.value).style("opacity",1),a.value.getBoundingClientRect();const C=c.value.getBoundingClientRect(),I=h.value.getBoundingClientRect(),N=C.right-I.width,V=C.bottom-I.height;let H=Math.min(w.clientX+20,N),J=Math.min(w.clientY+20,V);H==N&&J==V&&(H=w.clientX-I.width-20,J=w.clientY-I.height-20),j(h.value).style("left",H-C.left+"px").style("top",J-C.top+"px");const rt=[].concat(d.field_size).concat(d.field_color),kt=O=>{const Y=O.select("td.v1"),st=O.select("td.v2"),ct=O.select("td.v3"),lt=O.select("td.v4");return Y.text(E=>E),st.text(E=>A.data.summed_data[E]||0),ct.text(E=>s.data.summed_data[E]||0),lt.text(E=>{const Tt=A.data.summed_data[E]||0,Ct=s.data.summed_data[E]||0;return Math.floor(100*Tt/Ct)+"%"}),O};j(h.value).select("tbody").selectAll("tr").data(rt).join(O=>{const Y=O.append("tr"),st=Y.append("td"),ct=Y.append("td"),lt=Y.append("td"),E=Y.append("td");return st.attr("class","v1"),ct.attr("class","v2"),lt.attr("class","v3"),E.attr("class","v4"),kt(Y)},kt,O=>O.remove())}).on("mouseleave",(w,A)=>{const B=j(w.currentTarget).select("rect");S(B,f,r,!1),j(h.value).style("opacity",0)})},$=function(i){e("zoomin",i.data.name)},U=async function(i,s){const f=ft().duration(0).ease(pt),r=ft().duration(500).ease(pt),l=j(c.value).select("g"),g=j(c.value).append("g");{const b=P().domain([i.x0,i.x1]).rangeRound([0,_.value]),T=P().domain([i.y0,i.y1]).rangeRound([0,y.value]);R(l,i,b,T,!0,f),R(g,s,b,T,!0,f)}{const b=P().domain([s.x0,s.x1]).rangeRound([0,_.value]),T=P().domain([s.y0,s.y1]).rangeRound([0,y.value]);R(l,i,b,T,!0,r),R(g,s,b,T,!0,r)}l.attr("opacity",1).transition(r).attr("opacity",0),g.attr("opacity",0).transition(r).attr("opacity",1),l.transition(r).remove(),await r.end(),await vt(s.data)},W=function(i){const s=mt(i).sum(l=>l.children.length?0:p(l));return _e().tile(we).size([_.value,y.value*1.8]).round(!0)(s)},X=new Date("2020-01-01"),Q=i=>Math.floor((i-X)/(7*24*60*60*1e3)),nt=i=>new Date(X.getTime()+i*7*24*60*60*1e3),gt=function(i){const s=Q(d.dates[1]),f=r=>{r.children||(r.children=[]);const l={};r.data&&Object.keys(r.data).sort((g,b)=>parseInt(g)-parseInt(b)).filter(g=>parseInt(g)<=s).forEach(g=>{for(const b in r.data[g])l[b]=r.data[g][b]});for(const g of r.children){f(g);for(const b in g.summed_data)l[b]||(l[b]=0),l[b]+=g.summed_data[b]}r.summed_data=l};f(i)},vt=async i=>{const s=new Date,f=Q(d.dates[0]),r=Q(d.dates[1]),l=[].concat(d.field_size).concat(d.field_color),g=[];for(const T of l){await new Promise(B=>setTimeout(B,0));const w=Array(r+1).fill(0),A=[i];for(;A.length>0;){const B=A.pop();for(const I of B.children)A.push(I);if(!B.data)continue;let C=0;Object.keys(B.data).sort((I,N)=>I-N).forEach(I=>{var H;const N=(H=B.data[I])==null?void 0:H[T];if(N===void 0)return;const V=parseInt(I);V<=r&&(w[V]+=N-C),C=N})}w.forEach((B,C)=>{C>0&&(w[C]+=w[C-1])}),w.splice(0,f),g.push({label:T,extra_label:" = "+zt(",d")(w.slice(-1)[0]),formatter:zt(",d"),values:w.map((B,C)=>({x:nt(f+C),y:B}))})}x.value=g,console.log("Historical data computed in",(new Date-s)/1e3,"seconds")},Bt=async function(){if(v.value)return;const i=r=>{if(!r.children){for(const g of[".h",".cc",".cpp",".c",".hpp"])if(r.name.endsWith(g))return r;return null}const l=r.children.map(i).filter(g=>g);return l.length==0?null:{...r,children:l}},s=await fetch(`/treemap/${d.repositories[0]}/latest.json`),f=i(await s.json());gt(f),v.value=f},it=function(i){let s=z.value;for(const f of i)for(let r of s.children)if(r.data.name==f){s=r;break}return s},_t=async function(){m=o[d.colormap],j(c.value).select("g").node()||j(c.value).append("g");const i=it(d.path),s=j(c.value).select("g"),f=P().domain([i.x0,i.x1]).rangeRound([0,_.value]),r=P().domain([i.y0,i.y1]).rangeRound([0,y.value]),l=ft().duration(300).ease(d.animate?pt:Ht);R(s,i,f,r,!1,l),await l.end(),await vt(i.data),console.log("emit animationend"),e("animationend")},wt=async function(){await new Promise(i=>setTimeout(i,0)),gt(v.value),z.value=W(v.value),await _t()},Rt=async function(i,s){const f=it(s),r=it(i);await U(f,r)},At=St(()=>[...d.path]);dt(()=>[d.repositories,d.field_size,d.field_color,d.dates],wt),dt(()=>[d.colormap,d.colormapMin,d.colormapMax],_t),dt(At,Rt);const yt=async function(){for(;!a.value;)await new Promise(i=>setTimeout(i,100));_.value=a.value.clientWidth,y.value=Math.max(_.value*.5,window.innerHeight-300),await wt()};return $t(async()=>{await Bt(),yt(),window.addEventListener("resize",yt)}),(i,s)=>{const f=Nt("b-skeleton"),r=It;return G(),K("div",null,[D("div",ye,[ht(i.$slots,"top",{},void 0,!0)]),D("div",ke,[D("div",xe,[L(v)?(G(),K("div",{key:1,ref_key:"container",ref:a},[D("table",{class:"treemap-tooltip",ref_key:"tooltip",ref:h},[D("thead",null,[D("tr",null,[D("td",null,jt(L(u)),1),be,ze,Be])]),Re],512),(G(),K("svg",{width:L(_),height:L(y)},[D("g",{ref_key:"content",ref:c},null,512)],8,Ae)),ht(i.$slots,"colormap",{},void 0,!0)],512)):(G(),K("div",Me,[(G(),K(xt,null,Mt(20,l=>bt(f,{key:l,width:(l*16546+13*l*l)%100+"%",animated:""},null,8,["width"])),64))]))])]),D("div",Te,[D("div",Ce,[D("div",{width:L(_),height:L(y)},[L(x)?(G(),qt(r,{key:0,data:L(x),width:L(_),height:L(y)},null,8,["data","width","height"])):(G(),K(xt,{key:1},Mt(20,l=>bt(f,{key:l,width:(l*16546+13*l*l)%100+"%",animated:""},null,8,["width"])),64))],8,Ie)])]),D("div",De,[ht(i.$slots,"bottom",{},void 0,!0)])])}}}),Ve=Pt(Se,[["__scopeId","data-v-897737a2"]]);export{Ve as _};
